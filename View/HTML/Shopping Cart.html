{% if current_user.is_authenticated %}
    {% extends 'base_signed_in.html' %}
{% else %}
    {% extends 'base.html' %}
{% endif %}

{% block head %}
<title>Shopping Cart</title>
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/shopping_cart.css') }}">
{% endblock %}

{% block body %}
<script type="text/javascript">
  function remove_course(courseID){
    var currentUser = '{{current_username}}';
    db.collection("Users").where("username", "==", currentUser)
    .get()
    .then((querySnapshot) => {
        querySnapshot.forEach((doc) => {
            db.collection("Users").doc(doc.id).update(
            {
              shopping_cart:firebase.firestore.FieldValue.arrayRemove(courseID)
            })
            .then(() => {
              alert("Successfully removed from cart!");
              location.reload();
            })
        });
    })

  }

  window.addEventListener('load', function() {
    var courses_cart = JSON.parse({{courseID_array|tojson}});
    var course_price = 0
    for (var i = 0; i < courses_cart.length; i++) {
      var courseID = courses_cart[i];
      //alert(courseID);
      db.collection("Courses").where("courseID", "==", courseID).get()
      .then((querySnapshot) => {
          querySnapshot.forEach((doc) => {
            course_price += parseFloat(doc.data()['price']);
            document.getElementById('total_cost').innerHTML = "S$"+String(course_price.toFixed(2));
          });
      })
    }

  })
</script>
<div class="shopping_cart_page">
  <div class="shopping_cart_title">
    <h1 style="font-family: 'STIXGeneral', serif;font-weight: bold;">Shopping Cart</h1>
    <br>
  </div>
  <div class="courses_cart_div" id="courses_cart_div">
    <p style="font-size:19px;">{{courses_cart|length}} Course(s) in Cart</p>

    {% for i in range(courses_cart|length) %}
    {% set course = courses_cart[i] %}
    <div class="course_overview_div">
        <img class="course-image" src="{{course.image}}" style="position:absolute;width:140px;height:80px;margin-top:10px;margin-left:10px;" alt="yoga_image" >
        <ul>
          <li class="name" id="name_{{course.name}}" style="font-size: 15px;padding-right:10px;">{{course.name}}</li>
          <li class="trainer" style="font-size: 11px;">{{course.trainer}}</li>
          <li class="rating" style="font-size: 11px;">â˜…{{'%0.1f'| format(course.rating|float)}}</li>
          <li style="font-size: 13px;color: #767676;">{{course.duration}} total hours | For {{course.level}}</li>
        </ul>
        <div class="price_div">
          <p style="font-size: 18px;font-weight: bold;">${{'%0.2f'| format(course.price|float)}}</p>
          <button id="remove_btn" onclick="remove_course('{{course.courseID}}')"><img src="../static/images/trashcan.png" style="width:10px;display:inline-block"> Remove</button>
        </div>

    </div>
    {% endfor %}
  </div>
  <div class="products_cart_div">
    <p style="font-size:19px;">{{products_cart|length}} Item(s) in Cart</p>
  </div>
  <div class="checkout_div">
    <p style="font-size:19px;font-weight:300;margin-bottom:0px;">Total:</p>
    <h1 id="total_cost">S$34.99</h1>
    <button class="checkout_btn" type="button" name="button" onclick="">Checkout</button>
    <br>
    <p style="font-size:15px;font-weight:600;">Promotions</p>
    <input type="text" id="search_input" name="search_input" placeholder="Enter promo code">
    <button id="apply_btn" onclick="check_promocode()">Apply</button>
  </div>
</div>

{% endblock %}
